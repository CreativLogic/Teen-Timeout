<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teen Timeout</title>
<style>
  :root{
    --bg-start:#0d0f14; --bg-end:#1a1f2b;
    --dice:#ffffff; --text:#e9ecf1; --muted:#a9b0be; --accent:#ff3b30;
    --shadow: 0 20px 50px rgba(0,0,0,.55), 0 8px 20px rgba(0,0,0,.45);
    --dice-shadow: 0 12px 24px rgba(0,0,0,.45), inset 0 2px 0 rgba(255,255,255,.6);
    --radius:16px; --radius-lg:24px; --speed:900ms;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background: radial-gradient(1200px 800px at 70% -10%, #2c3345 0%, transparent 40%),
                radial-gradient(900px 700px at -10% 100%, #242b3a 0%, transparent 55%),
                linear-gradient(160deg, var(--bg-start), var(--bg-end));
    display:flex;align-items:center;justify-content:center;padding:28px;
  }
  .wrap{width:min(100%,1100px)}
  header{text-align:center;margin-bottom:22px}
  .title{font-weight:900;letter-spacing:.6px;margin:0 0 6px 0;text-align:center;opacity:.9}
  .banner{
    display:inline-block;padding:14px 20px;border-radius:var(--radius);
    background:linear-gradient(180deg,#161a24,#0f131b);
    box-shadow:var(--shadow);letter-spacing:.5px;font-weight:800;
    font-size:clamp(18px,3vw,28px);text-transform:uppercase
  }
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:24px;position:relative;overflow:hidden;
  }
  .grid{display:grid;grid-template-columns:1fr;gap:22px}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  .die{
    background:var(--dice);color:#111;border-radius:20px;padding:22px;min-height:180px;
    display:flex;align-items:center;justify-content:center;text-align:center;
    font-weight:800;font-size:clamp(18px,2.6vw,28px);line-height:1.25;
    box-shadow:var(--dice-shadow);transform-style:preserve-3d;
    transition:transform var(--speed) cubic-bezier(.2,.7,.2,1);position:relative
  }
  .die::after{
    content:"";position:absolute;inset:0;border-radius:20px;
    background:radial-gradient(300px 140px at 20% 10%, rgba(255,255,255,.35), transparent 60%),
               radial-gradient(220px 120px at 80% 90%, rgba(0,0,0,.04), transparent 60%);
    pointer-events:none;mix-blend-mode:screen
  }
  .die-label{position:absolute;top:12px;left:16px;font-size:12px;letter-spacing:.8px;color:#444;font-weight:700;text-transform:uppercase}
  .controls{margin-top:18px;display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  .btn{
    cursor:pointer;border:0;padding:13px 18px;border-radius:12px;font-weight:800;letter-spacing:.3px;
    background:linear-gradient(180deg,#3a7cff,#2c5fe0);color:white;
    box-shadow:0 10px 20px rgba(42,110,255,.35), inset 0 1px 0 rgba(255,255,255,.4);
    transition:transform .08s ease, filter .2s ease
  }
  .btn:hover{filter:brightness(1.07)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{
    background:linear-gradient(180deg,#5c6577,#475163);
    box-shadow:0 10px 20px rgba(60,70,90,.35), inset 0 1px 0 rgba(255,255,255,.25);
  }
  .toggle, .lock, .mode {
    display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-weight:700;color:var(--text)
  }
  .result{margin-top:10px;font-size:clamp(18px,2.2vw,24px);font-weight:900;color:var(--accent);letter-spacing:.3px;min-height:1.5em}
  .footer{margin-top:18px;text-align:center;color:var(--muted);font-weight:700}
  .legal{margin-top:6px;font-size:12px;color:#7d8596}
  .rolling{animation:wobble var(--speed) ease-in-out}
  @keyframes wobble{
    0%{transform:rotate3d(1,0,0,0deg) rotateZ(0deg)}
    25%{transform:rotate3d(1,.6,0,160deg) rotateZ(12deg)}
    60%{transform:rotate3d(.2,1,0,300deg) rotateZ(-10deg)}
    100%{transform:rotate3d(0,0,0,360deg) rotateZ(0deg)}
  }
  .side{
    display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:12px
  }
  .history{
    margin-top:16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
    border-radius:14px;padding:12px
  }
  .history h3{margin:0 0 8px 0;font-size:14px;color:#cbd2e0;text-transform:uppercase;letter-spacing:.6px}
  .history ul{list-style:none;margin:0;padding:0;max-height:160px;overflow:auto}
  .history li{font-size:14px;padding:6px 4px;border-bottom:1px dashed rgba(255,255,255,.08)}
  .history li:last-child{border-bottom:0}
  .suggestion{
    margin-top:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);
    border-radius:14px;padding:12px;font-weight:700;color:#eaeef7
  }
  dialog {
    border:none;border-radius:14px;padding:0;max-width:420px;width:92%;
    background:#0f131b;color:#e9ecf1;box-shadow:var(--shadow);
  }
  dialog .modal-inner{padding:18px}
  dialog .close-x{position:absolute;right:10px;top:8px;cursor:pointer;font-weight:900}
  dialog input, dialog textarea{
    width:100%;padding:12px;border-radius:10px;border:1px solid #2b3242;background:#141a25;color:#e9ecf1;font-weight:700
  }
  dialog textarea{min-height:90px;resize:vertical}
  dialog .row{display:flex;gap:10px;margin-top:12px}
  canvas#confetti{position:fixed;inset:0;pointer-events:none}

  /* PARENT'S CHOICE banner */
  .pc-banner{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center;
    font-weight:900; font-size:clamp(36px, 10vw, 120px); color:#fff;
    text-transform:uppercase; letter-spacing:4px; opacity:0.0; pointer-events:none;
  }
  .pc-banner.show{ display:flex; animation: pcflash 1200ms ease-in-out 1; }
  @keyframes pcflash{
    0%{ opacity:0; transform: scale(0.98) rotate(-1deg)}
    20%{ opacity:.5 }
    50%{ opacity:.35; transform: scale(1.02) rotate(1deg)}
    80%{ opacity:.5 }
    100%{ opacity:0; transform: scale(1) }
  }
  .pc-banner span{
    background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.2));
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow: 0 8px 30px rgba(0,0,0,.45);
  }

  .tiny-copy{margin-top:6px; font-size:11px; color:#9aa3b7}
</style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="wrap">
  <header>
    <h2 class="title">Teen Timeout</h2>
    <div class="banner" role="heading" aria-level="1">ROLL THE DICE TO DECIDE YOUR FATE</div>
  </header>

  <section class="card" aria-live="polite">
    <div class="pc-banner" id="pcBanner"><span>PARENT‚ÄôS CHOICE</span></div>

    <div class="grid">
      <div class="die" id="die-consequence" aria-label="Consequence die" tabindex="0">
        <div class="die-label">Consequence</div>
        <div id="die-consequence-text">Corner time</div>
      </div>
      <div class="die" id="die-time" aria-label="Time die" tabindex="0">
        <div class="die-label">Time limit</div>
        <div id="die-time-text">1 day</div>
      </div>
    </div>

    <div class="side">
      <div class="mode" role="group" aria-label="Roll mode">
        <label><input type="radio" name="mode" value="single" checked> Single Roll</label>
        <label><input type="radio" name="mode" value="best3"> Best of 3</label>
      </div>

      <div class="toggle">
        <input type="checkbox" id="double" />
        <label for="double">Double or Nothing</label>
      </div>

      <div class="lock">
        <button id="lockBtn" class="btn secondary" type="button">Parent Lock</button>
        <span id="lockState" style="font-weight:800">Unlocked</span>
      </div>

      <div class="controls">
        <button id="roll" class="btn" aria-label="Roll both dice">Roll</button>
        <button id="reroll-one" class="btn" aria-label="Re-roll one die">Re-roll One</button>
        <button id="share" class="btn" aria-label="Share last roll">Share</button>
        <button id="rulesBtn" class="btn secondary" aria-label="Show rules">Rules</button>
        <button id="clear-history" class="btn secondary" aria-label="Clear history">Clear</button>
      </div>
    </div>

    <div class="controls" style="margin-top:10px">
      <button id="setPC" class="btn secondary" type="button">Set Parent‚Äôs choice</button>
      <span id="pcStatus" style="opacity:.85">Hidden until landed</span>
    </div>

    <div class="result" id="result" aria-live="assertive"></div>

    <div class="suggestion" id="suggestion">Tip appears here after you roll.</div>

    <div class="history">
      <h3>Last 10 Rolls</h3>
      <ul id="history"></ul>
      <div class="tiny-copy">cooyright¬©Ô∏è2025 DAD BOD ENT.</div>
    </div>

    <div class="footer">
      LET THIS BE A LESSON. PARENTS ALWAYS WIN.üèÜ #loveyou
      <div class="legal">Randomness is uniform. No side is favored.</div>
    </div>
  </section>
</div>

<!-- PIN modal -->
<dialog id="pinModal">
  <div class="modal-inner">
    <div class="close-x" id="pinClose">√ó</div>
    <h3 style="margin:0 0 8px 0">Parent Lock PIN</h3>
    <p style="margin:0 0 12px 0;font-size:14px;color:#cbd2e0" id="pinHelp">Set a 4 digit PIN.</p>
    <input id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" aria-label="PIN" />
    <div class="row">
      <button class="btn secondary" id="pinCancel" type="button">Cancel</button>
      <button class="btn" id="pinOk" type="button">OK</button>
    </div>
  </div>
</dialog>

<!-- Parent‚Äôs choice modal -->
<dialog id="pcModal">
  <div class="modal-inner">
    <div class="close-x" id="pcClose">√ó</div>
    <h3 style="margin:0 0 8px 0">Set Parent‚Äôs choice</h3>
    <p style="margin:0 0 12px 0;font-size:14px;color:#cbd2e0">This is hidden and only revealed if landed on.</p>
    <textarea id="pcInput" placeholder="Type your custom punishment"></textarea>
    <div class="row">
      <button class="btn secondary" id="pcCancel" type="button">Cancel</button>
      <button class="btn" id="pcOk" type="button">Save</button>
    </div>
  </div>
</dialog>

<!-- Rules modal -->
<dialog id="rulesModal">
  <div class="modal-inner">
    <div class="close-x" id="rulesClose">√ó</div>
    <h3 style="margin:0 0 8px 0">Rules</h3>
    <ul style="line-height:1.5;margin:0 0 8px 16px;padding:0">
      <li>Pick Single Roll or Best of 3.</li>
      <li>Best of 3 picks the majority. If all different, the result with higher time severity wins.</li>
      <li>Double or Nothing affects time only. If Nothing hits, the punishment is cleared.</li>
      <li>Parent‚Äôs choice stays hidden unless landed on.</li>
      <li>History resets every time you load the app.</li>
    </ul>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="rulesOk" type="button">Got it</button>
    </div>
  </div>
</dialog>

<script>
  // Data
  const CONSEQUENCES = ["Corner time","No TV","Parent‚Äôs choice","All chores","No friends","Sibling decides"];
  const TIMES = ["1 day","2 days","1 week","1x","2x","45 min"];
  const TIME_RANK = {"45 min":1,"1x":2,"1 day":3,"2x":4,"2 days":5,"1 week":6};
  const TIPS = [
    "Parents aren‚Äôt dictators‚Ä¶ ya know, maybe you can offer to wash their car?",
    "Wanna know a secret? Parents secretly like essays too. #justsayin",
    "Consider yourself luckyüçÄ ‚ÄîYour parents used to get beat with rulers & belts.",
    "Grandma once said she had to choose the stick to get beat with‚Ä¶ the thin ones hurt the most. ü§ï",
    "1.5M kids get proved wrong by their parents every 15 seconds. Let that sink in. ü´®",
    "There‚Äôs an ice pack in the freezer to help with this burn!üî•"
  ];

  // Crypto index
  function secureIndex(len){
    const max = 256 - (256 % len);
    let b; do { const u = new Uint8Array(1); crypto.getRandomValues(u); b=u[0]; } while (b>=max);
    return b % len;
  }

  function baseRoll(){ // returns raw roll without double-or-nothing
    return { consequence: CONSEQUENCES[secureIndex(CONSEQUENCES.length)],
             time: TIMES[secureIndex(TIMES.length)] };
  }

  function chooseBestOf3(r1, r2, r3){
    const arr = [r1,r2,r3];
    // majority by string key
    const key = r => `${r.consequence}|${r.time}`;
    const count = {};
    arr.forEach(r => count[key(r)] = (count[key(r)]||0)+1);
    const majority = arr.find(r => count[key(r)] >= 2);
    if(majority) return majority;
    // tie-breaker by time severity
    return arr.slice().sort((a,b)=> (TIME_RANK[b.time]||0) - (TIME_RANK[a.time]||0))[0];
  }

  // Double or Nothing on time only. If Nothing, clear punishment entirely.
  function applyDoubleOrNothing(c, t){
    const heads = Math.random() < 0.5;
    if(!heads){ return { consequence:"Nothing", time:"Nothing", note:"Nothing" }; }
    function doubled(s){
      switch(s){
        case "1 day": return "2 days";
        case "2 days": return "4 days";
        case "1 week": return "2 weeks";
        case "45 min": return "90 min";
        case "1x": return "2x";
        case "2x": return "4x";
        default: return s;
      }
    }
    return { consequence: c, time: doubled(t), note: "Double" };
  }

  // Elements
  const dieC = document.getElementById("die-consequence");
  const dieT = document.getElementById("die-time");
  const dieCText = document.getElementById("die-consequence-text");
  const dieTText = document.getElementById("die-time-text");
  const resultEl = document.getElementById("result");
  const suggestionEl = document.getElementById("suggestion");
  const historyEl = document.getElementById("history");
  const btnRoll = document.getElementById("roll");
  const btnRerollOne = document.getElementById("reroll-one");
  const btnClear = document.getElementById("clear-history");
  const btnShare = document.getElementById("share");
  const chkDouble = document.getElementById("double");
  const lockBtn = document.getElementById("lockBtn");
  const lockState = document.getElementById("lockState");
  const rulesBtn = document.getElementById("rulesBtn");
  const pcBanner = document.getElementById("pcBanner");

  // Mode
  let mode = "single";
  document.querySelectorAll('input[name="mode"]').forEach(r=>{
    r.addEventListener('change', e => { mode = e.target.value; });
  });

  // Confetti
  const confettiCanvas = document.getElementById("confetti"); const ctx = confettiCanvas.getContext("2d");
  function resizeCanvas(){ confettiCanvas.width = innerWidth; confettiCanvas.height = innerHeight; }
  addEventListener("resize", resizeCanvas); resizeCanvas();
  let confetti = [];
  function burstConfetti(){
    confetti = [];
    for(let i=0;i<200;i++){
      confetti.push({x: confettiCanvas.width/2,y: confettiCanvas.height/3,r: Math.random()*4+2,
        vx: (Math.random()-0.5)*8,vy: Math.random()*-6-2,g: 0.15+Math.random()*0.15,a:1});
    }
    animateConfetti();
  }
  function animateConfetti(){
    ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    confetti.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.a-=0.007;
      ctx.globalAlpha = Math.max(p.a,0);
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle = ["#ff3b30","#34c759","#0a84ff","#ffcc00","#af52de"][secureIndex(5)];
      ctx.fill();
    });
    ctx.globalAlpha = 1;
    confetti = confetti.filter(p=>p.a>0 && p.y<confettiCanvas.height+10);
    if(confetti.length>0) requestAnimationFrame(animateConfetti);
  }

  // WebAudio minimal SFX
  const AudioCtx = window.AudioContext || window.webkitAudioContext; let audioCtx;
  function ensureAudio(){ if(!audioCtx) audioCtx = new AudioCtx(); }
  function playRumble(){
    ensureAudio();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = "triangle"; o.frequency.setValueAtTime(140, audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(55, audioCtx.currentTime+0.25);
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime+0.05);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.4);
    o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.42);
  }
  function playChime(){
    ensureAudio();
    const notes = [523.25,659.25,783.99]; let t = audioCtx.currentTime;
    notes.forEach(f=>{ const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type="sine"; o.frequency.value=f; g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.25,t+0.05);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.25);
      o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+0.28); t+=0.06; });
  }
  function playSad(){
    ensureAudio();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type="sine"; o.frequency.setValueAtTime(392, audioCtx.currentTime);
    o.frequency.linearRampToValueAtTime(196, audioCtx.currentTime+0.35);
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.38);
    o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.4);
  }
  function haptic(p=[30]){ if(navigator.vibrate) navigator.vibrate(p); }

  // History in memory
  const history = [];
  function pushHistory(text){ history.unshift({when:new Date().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}), text}); if(history.length>10) history.pop(); renderHistory(); }
  function renderHistory(){ historyEl.innerHTML = history.map(h=>`<li><strong>${h.when}</strong> ‚Äî ${h.text}</li>`).join(""); }

  // Parent‚Äôs choice storage
  let parentsChoice = "";
  const pcModal = document.getElementById("pcModal");
  const pcInput = document.getElementById("pcInput");
  const pcStatus = document.getElementById("pcStatus");
  document.getElementById("setPC").addEventListener("click", ()=>{ if(isRolling) return; pcInput.value = parentsChoice; pcModal.showModal(); pcInput.focus(); });
  document.getElementById("pcOk").addEventListener("click", ()=>{ parentsChoice = pcInput.value.trim(); pcStatus.textContent = parentsChoice ? "Saved. Hidden until landed" : "Hidden until landed"; pcModal.close(); });
  document.getElementById("pcCancel").addEventListener("click", ()=> pcModal.close());
  document.getElementById("pcClose").addEventListener("click", ()=> pcModal.close());

  // Rules modal
  const rulesModal = document.getElementById("rulesModal");
  rulesBtn.addEventListener("click", ()=>{ if(isRolling) return; rulesModal.showModal(); });
  document.getElementById("rulesOk").addEventListener("click", ()=> rulesModal.close());
  document.getElementById("rulesClose").addEventListener("click", ()=> rulesModal.close());

  // PIN modal
  const pinModal = document.getElementById("pinModal");
  const pinInput = document.getElementById("pinInput");
  const pinHelp = document.getElementById("pinHelp");
  const pinCancel = document.getElementById("pinCancel");
  const pinOk = document.getElementById("pinOk");
  const pinClose = document.getElementById("pinClose");
  let parentPIN = null; let locked = false;
  function updateLockUI(){
    lockState.textContent = locked ? "Locked" : "Unlocked";
    chkDouble.disabled = locked;
    lockBtn.textContent = locked ? "Unlock" : (parentPIN ? "Lock" : "Set PIN");
  }
  lockBtn.addEventListener("click", ()=>{
    if(isRolling) return;
    if(!parentPIN){
      pinHelp.textContent = "Set a 4 digit PIN."; pinInput.value = ""; pinModal.showModal();
      pinOk.onclick = ()=>{ const v=pinInput.value.trim(); if(/^\d{4}$/.test(v)){ parentPIN=v; locked=true; pinModal.close(); updateLockUI(); } };
    } else if(!locked){
      locked = true; updateLockUI();
    } else {
      pinHelp.textContent = "Enter PIN to unlock."; pinInput.value=""; pinModal.showModal();
      pinOk.onclick = ()=>{ if(pinInput.value===parentPIN){ locked=false; pinModal.close(); updateLockUI(); } };
    }
  });
  pinCancel.addEventListener("click", ()=> pinModal.close());
  pinClose.addEventListener("click", ()=> pinModal.close());

  chkDouble.addEventListener("click", e=>{
    if(locked){ e.preventDefault(); pinHelp.textContent="Enter PIN to change Double or Nothing."; pinInput.value=""; pinModal.showModal();
      pinOk.onclick = ()=>{ if(pinInput.value === parentPIN){ locked=false; updateLockUI(); pinModal.close(); chkDouble.click(); } };
    }
  });

  // Spin animation flag
  let isRolling = false;
  function animateDice(){
    isRolling = true;
    dieC.classList.remove("rolling"); dieT.classList.remove("rolling");
    void dieC.offsetWidth; void dieT.offsetWidth;
    dieC.classList.add("rolling"); dieT.classList.add("rolling");
  }

  // Share
  let lastShareText = "";
  async function share(){
    const text = lastShareText || "Teen Timeout";
    if(navigator.share){ try{ await navigator.share({text}); }catch{} }
    else {
      try{ await navigator.clipboard.writeText(text); alert("Copied to clipboard."); }
      catch{ prompt("Copy this", text); }
    }
  }

  // Finalize display
  function showParentsChoiceBanner(){
    pcBanner.classList.remove("show");
    void pcBanner.offsetWidth;
    pcBanner.classList.add("show");
    burstConfetti();
  }

  function finalizeResult(c, t, note){
    isRolling = false;
    if(c === "Parent‚Äôs choice"){ showParentsChoiceBanner(); }
    const displayTime = c==="Nothing" ? "Nothing" : t;
    const line = `${c} ‚Ä¶ ${displayTime}${note?` (${note})`:``}`;
    resultEl.textContent = line;
    suggestionEl.textContent = TIPS[secureIndex(TIPS.length)];
    pushHistory(line);
    lastShareText = `Teen Timeout\n${line}\nLET THIS BE A LESSON. PARENTS ALWAYS WIN.üèÜ #loveyou`;
  }

  function applyParentsChoiceText(c){
    if(c==="Parent‚Äôs choice"){
      if(parentsChoice){ return `Parent‚Äôs choice: ${parentsChoice}`; }
      return "Parent‚Äôs choice";
    }
    return c;
  }

  // Rollers
  function doSingleRoll(afterSpinCb){
    const r = baseRoll();
    dieCText.textContent = r.consequence;
    dieTText.textContent = r.time;
    afterSpinCb(r);
  }

  function doBestOf3(afterSpinCb){
    const s1 = baseRoll(), s2 = baseRoll(), s3 = baseRoll();
    const picked = chooseBestOf3(s1,s2,s3);
    dieCText.textContent = picked.consequence;
    dieTText.textContent = picked.time;
    afterSpinCb(picked);
  }

  function performRoll(){
    playRumble(); haptic([20,30,20]); animateDice();
    const spinC = [...CONSEQUENCES].sort(()=>Math.random()-.5);
    const spinT = [...TIMES].sort(()=>Math.random()-.5);
    let k=0, ticks=14, interval=Math.floor(900/ticks);
    const timer = setInterval(()=>{
      dieCText.textContent = spinC[k % spinC.length];
      dieTText.textContent = spinT[k % spinT.length];
      if(++k>ticks){
        clearInterval(timer);
        const after = r=>{
          // Apply Double or Nothing after selection
          let c = r.consequence; let t = r.time; let note=null;
          if(chkDouble.checked){
            const dn = applyDoubleOrNothing(c, t);
            c = dn.consequence; t = dn.time; note = dn.note;
            if(note==="Double"){ playChime(); burstConfetti(); haptic([40,40,40]); }
            else { playSad(); haptic([15,80]); }
          } else { playChime(); haptic([25,30]); }

          // Show parent's custom text only if landed on
          const cDisplay = c==="Parent‚Äôs choice" ? (parentsChoice ? `Parent‚Äôs choice: ${parentsChoice}` : "Parent‚Äôs choice") : c;
          finalizeResult(cDisplay, t, note);
        };
        if(mode==="single") doSingleRoll(after); else doBestOf3(after);
      }
    }, interval);
  }

  function rerollOne(){
    if(isRolling) return;
    playRumble(); haptic([20,30,20]); animateDice();
    const target = Math.random()<0.5?"C":"T";
    let k=0, ticks=10, interval=Math.floor(900/ticks);
    const tmr = setInterval(()=>{
      if(target==="C") dieCText.textContent = CONSEQUENCES[secureIndex(CONSEQUENCES.length)];
      else dieTText.textContent = TIMES[secureIndex(TIMES.length)];
      if(++k>ticks){
        clearInterval(tmr);
        if(target==="C") dieCText.textContent = CONSEQUENCES[secureIndex(CONSEQUENCES.length)];
        else dieTText.textContent = TIMES[secureIndex(TIMES.length)];
        // finalize from current faces with DoN
        let c = dieCText.textContent; let t = dieTText.textContent; let note=null;
        if(chkDouble.checked){
          const dn = applyDoubleOrNothing(c, t);
          c = dn.consequence; t = dn.time; note = dn.note;
          if(note==="Double"){ playChime(); burstConfetti(); haptic([40,40,40]); }
          else { playSad(); haptic([15,80]); }
        } else { playChime(); haptic([25,30]); }
        const cDisplay = c==="Parent‚Äôs choice" ? (parentsChoice ? `Parent‚Äôs choice: ${parentsChoice}` : "Parent‚Äôs choice") : c;
        finalizeResult(cDisplay, t, note);
      }
    }, interval);
  }

  // Wire UI
  btnRoll.addEventListener("click", ()=>{ if(isRolling) return; performRoll(); });
  btnRerollOne.addEventListener("click", rerollOne);
  btnShare.addEventListener("click", share);
  btnClear.addEventListener("click", ()=>{ history.length=0; renderHistory(); resultEl.textContent=""; suggestionEl.textContent=""; });
  [dieC,dieT].forEach(el=>el.addEventListener("keydown", e=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); if(!isRolling) performRoll(); }}));

  // On load
  window.addEventListener("load", ()=>{
    history.length=0; renderHistory(); updateLockUI();
  });
</script>
</body>
</html>
